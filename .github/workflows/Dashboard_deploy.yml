name: Deploy to EC2 with Docker Compose

on:
  workflow_dispatch:   # üëà Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install SSH Client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Connect to EC2 and Deploy
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            # 1) Update system and install Docker if not installed
            if ! command -v docker &> /dev/null
            then
              echo "Docker not found. Installing..."
              sudo yum update -y
              sudo amazon-linux-extras install docker -y || sudo yum install docker -y
              sudo systemctl start docker
              sudo systemctl enable docker
            else
              echo "Docker already installed."
            fi

            # Install Docker Compose if not present
            if ! command -v docker-compose &> /dev/null
            then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            else
              echo "Docker Compose already installed."
            fi

           # 2) Install git if not present
            if ! command -v git &> /dev/null
            then
              echo "Installing Git..."
              sudo yum install -y git
            else
              echo "Git already installed."
            fi

            # 3) Remove old repo if exists, then clone latest
            if [ -d "CI-CD-Monitoring-Dashboard" ]; then
              echo "Removing old repo..."
              sudo rm -rf CI-CD-Monitoring-Dashboard
            fi
            git clone git@github.com:iam-saurabh-bhale/CI-CD-Monitoring-Dashboard.git

            cd CI-CD-Monitoring-Dashboard/.github-actions-dashboard

            # 4) Stop and remove all containers + images
            echo "Cleaning up old containers and images..."
            sudo docker ps -aq | xargs -r sudo docker stop
            sudo docker ps -aq | xargs -r sudo docker rm
            sudo docker images -q | xargs -r sudo docker rmi -f

            # 5) Start containers with docker-compose
            echo "Starting new containers..."
            sudo docker-compose up -d --build

            # 6) Wait 15s and verify 3 containers running
            echo "Waiting 15 seconds for containers to start..."
            sleep 15
            RUNNING=$(sudo docker ps -q | wc -l)

            if [ "$RUNNING" -eq 3 ]; then
              echo "‚úÖ Success: All 3 containers are running."
              exit 0
            else
              echo "‚ùå Error: Expected 3 containers, but found $RUNNING."
              exit 1
            fi
          EOF
